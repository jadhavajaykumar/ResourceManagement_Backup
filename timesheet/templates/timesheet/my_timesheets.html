{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block content %}
<div class="container py-4">
  <h2 class="mb-4 text-primary">My Timesheets</h2>

  <form method="post" class="card p-4 shadow-sm mb-4">
    {% csrf_token %}

    {% if form.non_field_errors %}
      <div class="alert alert-danger">
        {% for error in form.non_field_errors %}
          <p>{{ error }}</p>
        {% endfor %}
      </div>
    {% endif %}

    <div class="row g-3">
      <div class="col-md-4">
        <label>Project:</label>
        {{ form.project|add_class:"form-select" }}
      </div>
      <div class="col-md-4">
        <label>Task:</label>
        {{ form.task|add_class:"form-select" }}
      </div>
      <div class="col-md-4">
        <label>Date:</label>
        {{ form.date|add_class:"form-control" }}
      </div>
      <div class="col-md-3">
        <label>Time from:</label>
        {{ form.time_from|add_class:"form-control" }}
      </div>
      <div class="col-md-3">
        <label>Time to:</label>
        {{ form.time_to|add_class:"form-control" }}
      </div>
      <div class="col-md-12">
        <label>Task description:</label>
        {{ form.task_description|add_class:"form-control" }}
      </div>
    </div>
    <div class="mt-3">
      <button type="submit" class="btn btn-success">Submit Timesheet</button>
    </div>
  </form>

  {% if weekly_grouped %}
  <div class="accordion" id="weeklyTimesheetAccordion">
    {% for week_label, entries in weekly_grouped.items %}
    <div class="accordion-item mb-2">
      <h2 class="accordion-header" id="heading-{{ forloop.counter }}">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
          data-bs-target="#collapse-{{ forloop.counter }}">
          {{ week_label }} â€” {{ entries|length }} Entries
        </button>
      </h2>
      <div id="collapse-{{ forloop.counter }}" class="accordion-collapse collapse"
        data-bs-parent="#weeklyTimesheetAccordion">
        <div class="accordion-body">
          <table class="table table-striped table-bordered text-center">
            <thead class="table-light">
              <tr>
                <th>Date</th>
                <th>Project</th>
                <th>Time Slot</th>
                <th>Task Description</th>
                <th>Status</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              {% for entry in entries %}
              <tr>
                <td>{{ entry.date }}</td>
                <td>{{ entry.project.name }}</td>
                <td>{{ entry.time_from }} - {{ entry.time_to }}</td>
                <td>{{ entry.task_description }}</td>
                <td>{{ entry.status }}</td>
                <td>
                  {% if entry.status != 'Approved' %}
                  <a href="{% url 'timesheet:edit-timesheet' entry.id %}" class="btn btn-sm btn-primary">Edit</a>
                  <a href="{% url 'timesheet:delete_timesheet' entry.id %}" class="btn btn-sm btn-danger"
                    onclick="return confirm('Are you sure?');">Delete</a>
                  {% else %} - {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  const projectSelect = document.getElementById('id_project');
  const taskSelect = document.getElementById('id_task');

  if (projectSelect) {
    projectSelect.addEventListener('change', function () {
      const projectId = this.value;
      fetch(`/api/get-tasks-by-project/?project_id=${projectId}`)
        .then(response => response.json())
        .then(data => {
          taskSelect.innerHTML = '';
          if (data.tasks.length > 0) {
            data.tasks.forEach(task => {
              const option = document.createElement('option');
              option.value = task.id;
              option.text = task.name;
              taskSelect.appendChild(option);
            });
          } else {
            const option = document.createElement('option');
            option.text = 'No tasks available';
            taskSelect.appendChild(option);
          }
        });
    });
  }
});
</script>
{% endblock %}

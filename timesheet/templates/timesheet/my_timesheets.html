{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block content %}
<div class="container py-4">
  <h2 class="mb-4 text-primary">My Timesheets</h2>

  <div class="calendar">
    <h4 class="mt-4 mb-2">Calendar for {{ calendar_month|date:"F Y" }}</h4>
    <table class="table table-bordered text-center">
      <thead class="table-light">
        <tr>
          {% for day in days_of_week %}
          <th>{{ day }}</th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for week in calendar_weeks %}
        <tr>
          {% for date, status in week %}
          <td class="{% if status == 'not_submitted' %}bg-danger text-white
                     {% elif status == 'submitted' %}bg-warning
                     {% elif status == 'approved' %}bg-success text-white
                     {% elif status == 'partial' %}bg-info text-dark
                     {% elif status == 'coff' %}bg-primary text-white
                     {% endif %}">
            {{ date.day }}
          </td>
          {% endfor %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <h2 class="mb-4 text-primary">Submit Timesheet</h2>
  <form method="post" class="card p-4 shadow-sm mb-4">
    {% csrf_token %}

    {% if form.non_field_errors %}
    <div class="alert alert-danger">
      {% for error in form.non_field_errors %}
      <p>{{ error }}</p>
      {% endfor %}
    </div>
    {% endif %}

    <div class="row g-3">
      <div class="col-md-4">
        <label>Project:</label>
        {{ form.project|add_class:"form-select" }}
      </div>
      <div class="col-md-4">
        <label>Task:</label>
        {{ form.task|add_class:"form-select" }}
      </div>
      <div class="col-md-4">
        <label>Date:</label>
        {{ form.date|add_class:"form-control" }}
      </div>
      <div class="col-md-3">
        <label>Time from:</label>
        {{ form.time_from|add_class:"form-control" }}
      </div>
      <div class="col-md-3">
        <label>Time to:</label>
        {{ form.time_to|add_class:"form-control" }}
      </div>
      <div class="col-md-12">
        <label>Task description:</label>
        {{ form.task_description|add_class:"form-control" }}
      </div>
    </div>
    <div class="mt-3">
      <button type="submit" class="btn btn-success">Submit Timesheet</button>
    </div>
  </form>

  {% if weekly_grouped %}
  <div class="accordion" id="weeklyTimesheetAccordion">
    {% for week_label, entries in weekly_grouped.items %}
    <div class="accordion-item mb-2">
      <h2 class="accordion-header" id="heading-{{ forloop.counter }}">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
          data-bs-target="#collapse-{{ forloop.counter }}">
          {{ week_label }} â€” {{ entries|length }} Entries
        </button>
      </h2>
      <div id="collapse-{{ forloop.counter }}" class="accordion-collapse collapse"
        data-bs-parent="#weeklyTimesheetAccordion">
        <div class="accordion-body">
          <table class="table table-striped table-bordered text-center">
            <thead class="table-light">
              <tr>
                <th>Date</th>
                <th>Project</th>
                <th>Time Slot</th>
                <th>Task Descriptions</th>
                <th>Status</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              {% for group in entries %}
                {% if group.merged %}
                <tr>
                  <td>{{ group.date }}</td>
                  <td>{{ group.project }}</td>
                  <td>{{ group.start_time }} - {{ group.end_time }}</td>
                  <td>
                    <ul class="text-start">
                      {% for desc in group.descriptions %}
                        <li>{{ desc }}</li>
                      {% endfor %}
                    </ul>
                  </td>
                  <td>{{ group.status }}</td>
                  <td>-</td>
                </tr>
                {% else %}
                <tr>
                  <td>{{ group.date }}</td>
                  <td>{{ group.project.name }}</td>
                  <td>{{ group.time_from }} - {{ group.time_to }}</td>
                  <td>{{ group.task_description }}</td>
                  <td>{{ group.status }}</td>
                  <td>
                    {% if group.status != 'Approved' %}
                    <a href="{% url 'timesheet:edit-timesheet' group.id %}" class="btn btn-sm btn-primary">Edit</a>
                    <a href="{% url 'timesheet:delete_timesheet' group.id %}" class="btn btn-sm btn-danger"
                      onclick="return confirm('Are you sure?');">Delete</a>
                    {% else %} - {% endif %}
                  </td>
                </tr>
                {% endif %}
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  const projectSelect = document.getElementById('id_project');
  const taskSelect = document.getElementById('id_task');

  if (projectSelect) {
    projectSelect.addEventListener('change', function () {
      const projectId = this.value;
      fetch(`/api/get-tasks-by-project/?project_id=${projectId}`)
        .then(response => response.json())
        .then(data => {
          taskSelect.innerHTML = '';
          if (data.tasks.length > 0) {
            data.tasks.forEach(task => {
              const option = document.createElement('option');
              option.value = task.id;
              option.text = task.name;
              taskSelect.appendChild(option);
            });
          } else {
            const option = document.createElement('option');
            option.text = 'No tasks available';
            taskSelect.appendChild(option);
          }
        });
    });
  }
});
</script>
{% endblock %}

{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}
{% load timesheet_custom_filters %}

{% block content %}
<div class="container py-4">
    <h2 class="mb-4 text-primary">My Timesheets</h2>

    <!-- Month Filters -->
    <form method="get" class="row mb-3">
        <div class="col-md-2">
            <select name="month" class="form-select">
                {% for m in 1|get_range:12 %}
                    <option value="{{ m }}" {% if calendar_month == m %}selected{% endif %}>{{ m|stringformat:"02d" }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <select name="year" class="form-select">
                {% for y in 2022|get_range:2026 %}
                    <option value="{{ y }}" {% if calendar_year == y %}selected{% endif %}>{{ y }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <button type="submit" class="btn btn-primary">Go</button>
        </div>
    </form>

    <!-- Calendar -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            Timesheet Calendar — {{ calendar_month|stringformat:"02d" }}/{{ calendar_year }}
        </div>
        <div class="card-body">{{ styled_calendar_html|safe }}</div>
    </div>

    <!-- Timesheet Submission -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">Submit New Timesheet Entry</div>
        <div class="card-body">
            <form method="post" id="timesheet-form" action="{% url 'timesheet:submit-timesheet' %}">
                {% csrf_token %}
                {% if form.non_field_errors %}
                    <div class="alert alert-danger">
                        {% for error in form.non_field_errors %}
                            <p>{{ error }}</p>
                        {% endfor %}
                    </div>
                {% endif %}

                <div class="row mb-3">
                    <div class="col-md-3">
                        {{ form.date.label_tag }}
                        {{ form.date|add_class:"form-control" }}
                        {{ form.date.errors }}
                    </div>
                    <div class="col-md-3">
                        {{ form.shift_start.label_tag }}
                        {{ form.shift_start|add_class:"form-control" }}
                        {{ form.shift_start.errors }}
                    </div>
                    <div class="col-md-3">
                        {{ form.shift_end.label_tag }}
                        {{ form.shift_end|add_class:"form-control" }}
                        {{ form.shift_end.errors }}
                    </div>
                </div>

                <div class="mb-3">
                    <div class="form-check">
                        {{ form.is_billable|add_class:"form-check-input" }}
                        {{ form.is_billable.label_tag }}
                    </div>
                </div>

                <button type="button" id="generate-slots-btn" class="btn btn-primary mb-3">
                    Generate Time Slots
                </button>

                <div id="slots-section" class="d-none">
                    <h5>Time Slots</h5>
                    <table class="table table-bordered" id="time-slots-table">
                        <thead>
                            <tr>
                                <th>From</th>
                                <th>To</th>
                                <th>Hours</th>
                                <th>Project</th>
                                <th>Task</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                    <input type="hidden" name="slot_count" value="0">
                    <div class="alert alert-info total-hours-display">
                        <strong>Total Hours: 0.00</strong>
                    </div>
                    <button type="submit" class="btn btn-success">Submit Timesheet</button>
                </div>
            </form>
        </div>
    </div>

    {% if weekly_grouped %}
    <div class="card">
        <div class="card-header bg-primary text-white">My Timesheet Entries</div>
        <div class="card-body">
            <div class="accordion" id="accordionTimesheets">
                {% for week_label, entries in weekly_grouped.items %}
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#collapse-{{ forloop.counter }}">
                            {{ week_label }} — {{ entries|length }} Entries
                        </button>
                    </h2>
                    <div id="collapse-{{ forloop.counter }}" class="accordion-collapse collapse" data-bs-parent="#accordionTimesheets">
                        <div class="accordion-body p-0">
                            <table class="table table-striped mb-0">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Shift</th>
                                        <th>Hours</th>
                                        <th>Projects</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for entry in entries %}
                                    <tr>
                                        <td>{{ entry.date|date:"M d, Y" }}</td>
                                        <td>{{ entry.shift_start|time:"H:i" }}–{{ entry.shift_end|time:"H:i" }}</td>
                                        <td>{{ entry.total_hours|floatformat:2 }} hrs</td>
                                        <td>
                                            {% for slot in entry.time_slots.all %}
                                                {{ slot.project.name }}{% if not forloop.last %}, {% endif %}
                                            {% endfor %}
                                        </td>
                                        <td>
                                            <span class="badge {% if entry.status == 'Approved' %}bg-success{% elif entry.status == 'Rejected' %}bg-danger{% else %}bg-warning text-dark{% endif %}">
                                                {{ entry.status }}
                                            </span>
                                        </td>
                                        <td>
                                            {% if entry.status == 'Rejected' %}
                                                <a href="{% url 'timesheet:resubmit-timesheet' entry.id %}" class="btn btn-sm btn-primary">Resubmit</a>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}


{% block scripts %}
<!-- Load jQuery explicitly before anything else -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"
        integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
        crossorigin="anonymous"></script>

<script>
try {
    $(document).ready(function() {
        console.log("Document ready");
		
$(document).ready(function() {
    console.log("Document ready and jQuery loaded");

    $('#generate-slots-btn').on('click', function(e) {
        console.log("Generate Time Slot button clicked");
        e.preventDefault();

        const btn = $(this);
        btn.html('<span class="spinner-border spinner-border-sm" role="status"></span> Generating...');
        btn.prop('disabled', true);

        const formData = $('#timesheet-form').serialize();
        const csrfToken = $('input[name="csrfmiddlewaretoken"]').val();

        $.ajax({
            url: "{% url 'timesheet:generate-timeslots' %}",
            type: 'POST',
            data: formData,
            headers: { "X-CSRFToken": csrfToken },
            success: function(response) {
                console.log("AJAX success", response);
                if (response.success) {
                    const tableBody = $('#time-slots-table tbody').empty();

                    response.time_slots.forEach((slot, index) => {
                        const row = `
                        <tr>
                            <td><input type="time" name="slot_from_${index+1}" value="${slot.from_time}" class="form-control" readonly></td>
                            <td><input type="time" name="slot_to_${index+1}" value="${slot.to_time}" class="form-control" readonly></td>
                            <td>${slot.hours.toFixed(2)}</td>
                            <td>
                                <select name="slot_project_${index+1}" class="form-select project-select" data-slot="${index+1}" required>
                                    <option value="">Select Project</option>
                                    {% for project in assigned_projects %}
                                        <option value="{{ project.id }}">{{ project.name }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <select name="slot_task_${index+1}" id="slot_task_${index+1}" class="form-select task-select">
                                    <option value="">Select Task</option>
                                </select>
                            </td>
                            <td><textarea name="slot_description_${index+1}" class="form-control" rows="2"></textarea></td>
                        </tr>`;
                        tableBody.append(row);
                    });

                    $('input[name="slot_count"]').val(response.slot_count);
                    $('.total-hours-display').html(`<strong>Total Hours: ${response.total_hours.toFixed(2)}</strong>`);
                    $('#slots-section').removeClass('d-none');

                    $('.project-select').change(function() {
                        const slotId = $(this).data('slot');
                        const taskSelect = $(`#slot_task_${slotId}`);
                        loadTasks($(this).val(), taskSelect);
                    });

                    $('.project-select').each(function() {
                        const slotId = $(this).data('slot');
                        const taskSelect = $(`#slot_task_${slotId}`);
                        loadTasks($(this).val(), taskSelect);
                    });
                } else {
                    alert("Error: " + JSON.stringify(response.errors));
                }
            },
            error: function(xhr) {
                console.error("AJAX error", xhr.responseText);
                alert("AJAX request failed. Check console for details.");
            },
            complete: function() {
                btn.html('Generate Time Slots').prop('disabled', false);
            }
        });
    });

    function loadTasks(projectId, taskSelect) {
        if (!projectId) return taskSelect.html('<option value="">Select Task</option>');

        $.ajax({
            url: "{% url 'manager:load-tasks' %}",
            data: { project: projectId, employee: {{ employee_id }} },
            success: function(data) {
                taskSelect.html('<option value="">Select Task</option>');
                data.forEach(task => {
                    taskSelect.append(`<option value="${task.id}">${task.name}</option>`);
                });
            },
            error: function() {
                taskSelect.html('<option value="">Error loading tasks</option>');
            }
        });
    }
	});
    });
} catch (err) {
    console.error("Caught JS error:", err);
    alert("JS error: " + err.message);
}
</script>
{% endblock %}


{% extends "base.html" %}
{% load widget_tweaks %}
{% block content %}
<div class="container py-4">
  <h3>Create Timesheet Entry</h3>

  <form method="post" id="timesheet-create-form">
    {% csrf_token %}
    <div class="card p-3 mb-3">
      {{ form|crispy }}
    </div>

    <div class="card p-3">
      <h5>Time Slots</h5>
      {{ formset.management_form }}
      <div class="table-responsive">
        <table class="table table-bordered">
          <thead>
            <tr>
              <th>Project</th>
              <th>Task</th>
              <th>Description</th>
              <th>From</th>
              <th>To</th>
              <th class="text-center">Worked Onsite?</th>
              <th class="text-center">Delete</th>
            </tr>
          </thead>
          <tbody>
            {% for slot_form in formset %}
            <tr>
              {{ slot_form.id }}
              <td>{{ slot_form.project|add_class:"form-select" }}</td>
              <td>{{ slot_form.task|add_class:"form-select" }}</td>
              <td>{{ slot_form.description|add_class:"form-control" }}</td>
              <td>{{ slot_form.time_from|add_class:"form-control" }}</td>
              <td>{{ slot_form.time_to|add_class:"form-control" }}</td>

              <!-- inside the loop for slot_form in formset, replace the Worked Onsite td with: -->
				<td class="text-center">
				  {# render as a select (TimeSlotForm must use a Select widget) #}
				  {{ slot_form.worked_onsite|add_class:"form-select" }}
				  {% for error in slot_form.worked_onsite.errors %}
					<div class="text-danger small mt-1">{{ error }}</div>
				  {% endfor %}
				</td>


              <td class="text-center">
                {# For unsaved/new rows we show a client-side Remove button which simply checks DELETE and hides row #}
                <button type="button" class="btn btn-sm btn-outline-danger remove-new-slot">Remove</button>
                <div style="display:none;">{{ slot_form.DELETE }}</div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="mt-3">
        <button type="submit" class="btn btn-primary">Save / Submit</button>
        <a href="{% url 'timesheet:my-timesheets' %}" class="btn btn-secondary ms-2">Cancel</a>
      </div>
    </div>
  </form>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Remove button for new (unsaved) rows - it checks DELETE and hides the row.
  document.querySelectorAll('.remove-new-slot').forEach(function(btn) {
    btn.addEventListener('click', function() {
      const row = btn.closest('tr');
      if (!row) return;
      // find DELETE checkbox inside this row (name endswith -DELETE)
      const del = row.querySelector('input[type="checkbox"][name$="-DELETE"], input[name$="-DELETE"]');
      if (del) {
        // mark for deletion
        del.checked = true;
      }
      // hide row visually
      row.style.display = 'none';
    });
  });

  // Time validation (optional)
  const form = document.getElementById('timesheet-create-form');
  if (form) {
    form.addEventListener('submit', function(e){
      // optional validation similar to edit page if you have time fields at top-level
    });
  }
});
</script>
{% endblock %}

{% extends 'base.html' %}
{% load static %}
{% load timesheet_custom_filters %}
{% load currency_filters %}

{% block content %}
<div class="container-fluid">
    <h2 class="mb-4">Timesheet Approvals</h2>

    {% if messages %}
        <div class="mb-4">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }}">{{ message }}</div>
            {% endfor %}
        </div>
    {% endif %}

    <div class="accordion" id="employeeAccordion">
        {% for employee, timesheets in grouped_timesheets.items %}
            <div class="accordion-item mb-3">
                <h2 class="accordion-header" id="heading-{{ employee.id }}">
					<button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
							data-bs-target="#collapse-{{ employee.id }}" aria-expanded="false"
							aria-controls="collapse-{{ employee.id }}">
						{{ employee.user.get_full_name }}

						{% with pending_flags|get_item:employee.id as pending %}
							{% if pending %}
								<span class="ms-2 badge bg-warning text-dark">ðŸ”” Pending Approval</span>
							{% endif %}
						{% endwith %}
					</button>
				</h2>



                <div id="collapse-{{ employee.id }}" class="accordion-collapse collapse"
                     aria-labelledby="heading-{{ employee.id }}" data-bs-parent="#employeeAccordion">
                    <div class="accordion-body p-0">
                        <div class="table-responsive">
                            <table class="table table-bordered mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Date</th>
                                        <th>Project</th>
                                        <th>Task</th>
                                        <th>Description</th>
                                        <th>Shift Time</th>
                                        <th>Total Hours</th>
                                        <th>DA</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
									{% for timesheet in timesheets %}
										{% with slot=timesheet.time_slots.first %}
										<tr>
											<td>{{ timesheet.date|date:"M d, Y" }}</td>
											<td>
												{% if slot and slot.project %}
													{{ slot.project.name }}
												{% else %}
													-
												{% endif %}
											</td>
											<td>
												{% if slot and slot.task %}
													{{ slot.task.name }}
												{% else %}
													-
												{% endif %}
											</td>
											<td>
												{% if timesheet.time_slots.all %}
													<ul style="padding-left: 18px; margin: 0;">
														{% for slot in timesheet.time_slots.all %}
															{% if slot.description %}
																<li>{{ slot.description }}</li>
															{% endif %}
														{% endfor %}
													</ul>
												{% else %}
													-
												{% endif %}
											</td>

											<td>{{ timesheet.shift_start|time:"H:i" }} - {{ timesheet.shift_end|time:"H:i" }}</td>
											<td>{{ timesheet.get_total_hours }}</td>
											<td>
												{% with da_record=da_map|get_item:timesheet.id %}
													{% if da_record %}
														<span class="text-success fw-bold">
															{{ da_record.da_amount|currency_display:da_record.currency }}
															{% if da_record.is_extended %}
																<span title="Includes extra hours" class="text-warning">âš¡</span>
															{% endif %}
														</span>
													{% else %}
														<span class="text-muted">â€”</span>
													{% endif %}
												{% endwith %}
											</td>
											<td>
												<span class="badge bg-{% if timesheet.status == 'Approved' %}success
													{% elif timesheet.status == 'Pending' %}warning
													{% else %}danger{% endif %}">
													{{ timesheet.status }}
												</span>
											</td>
											<td>
											  {% if timesheet.status == 'Pending' %}
												<!-- Approve form -->
												<form method="post" action="{% url 'timesheet:handle-timesheet-action' timesheet.id 'approve' %}" class="mb-2">
												  {% csrf_token %}
												  <div class="input-group input-group-sm">
													<input type="text" name="approve_remark" class="form-control form-control-sm"
														   placeholder="Approval remark" required>
													<button type="submit" class="btn btn-success btn-sm">Approve</button>
												  </div>
												</form>

												<!-- Reject form -->
												<form method="post" action="{% url 'timesheet:handle-timesheet-action' timesheet.id 'reject' %}">
												  {% csrf_token %}
												  <div class="input-group input-group-sm">
													<input type="text" name="reject_remark" class="form-control form-control-sm"
														   placeholder="Rejection remark" required>
													<button type="submit" class="btn btn-danger btn-sm">Reject</button>
												  </div>
												</form>
											  {% else %}
												-
											  {% endif %}
											</td>

										</tr>
										{% endwith %}
									{% empty %}
										<tr>
											<td colspan="9" class="text-center">No timesheets for this employee.</td>
										</tr>
									{% endfor %}
								</tbody>

                            </table>
                        </div>
                    </div>
                </div>
            </div>
        {% empty %}
            <p class="text-muted">No timesheets available.</p>
        {% endfor %}
    </div>
</div>
{% endblock %}

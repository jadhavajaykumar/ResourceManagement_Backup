{% extends 'base.html' %}
{% block content %}
<div class="container-fluid">
  <h3>Employee Skill Matrix</h3>
  <div class="mb-3">
    <input id="skill-search" class="form-control" placeholder="Search employees or skills..." />
  </div>
  <div class="table-responsive">
    <table id="employee-skill-table" class="table table-striped table-bordered" style="width:100%">
      <thead id="skill-thead"></thead>
      <tbody id="skill-tbody"></tbody>
    </table>
  </div>
</div>
{% endblock %}

{% block scripts %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script>
$(document).ready(function(){
  const url = "{% url 'skills:employee-skills-table-json' %}";
  $.getJSON(url, function(data){
    const columns = data.columns;
    // build header
    let thead = '<tr>';
    columns.forEach(c => thead += `<th>${c}</th>`);
    thead += '</tr>';
    $('#skill-thead').html(thead);

    // build rows
    const rows = data.rows.map(r => {
      const base = [`<td><a href="/employee/profile/${r.employee_id}/">${r.employee_name}</a></td>`, `<td>${r.designation || ''}</td>`];
      const skills = columns.slice(2).map(k => {
        const s = r.skills[k];
        if (!s) return '<td class="text-muted">-</td>';
        const prof = s.proficiency;
        const cert = s.certified ? ' <i class="bi bi-award-fill text-success" title="Certified"></i>' : '';
        // show colored badge by proficiency
        let cls = 'badge bg-secondary';
        if (prof >= 80) cls = 'badge bg-success';
        else if (prof >= 50) cls = 'badge bg-warning text-dark';
        else cls = 'badge bg-secondary';
        return `<td><span class="${cls}">${prof}%</span> ${cert}</td>`;
      });
      return `<tr>${base.join('')}${skills.join('')}</tr>`;
    });

    $('#skill-tbody').html(rows.join(''));
    // Initialize DataTable
    $('#employee-skill-table').DataTable({
      paging: true,
      pageLength: 25,
      scrollX: true,
      autoWidth: false,
      lengthChange: true,
      dom: 'Bfrtip',
      buttons: ['csv', 'excel', 'pdf'],
    });
    // connect search input
    $('#skill-search').on('keyup', function(){
      $('#employee-skill-table').DataTable().search(this.value).draw();
    });
  });
});
</script>
{% endblock %}

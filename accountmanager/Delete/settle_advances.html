{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-4">
  <h3 class="mb-4 text-primary">Settle Advance Requests</h3>

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }}">{{ message }}</div>
    {% endfor %}
  {% endif %}

  {% if advances %}
    <div class="table-responsive">
      <table class="table table-striped table-hover align-middle">
        <thead class="table-light sticky-top">
          <tr>
            <th scope="col">ID</th>
            <th scope="col">Employee</th>
            <th scope="col">Project</th>
            <th scope="col">Amount</th>
            <th scope="col">Purpose</th>
            <th scope="col">Requested</th>
            <th scope="col">Approvals</th>
            <th scope="col">Action</th>
          </tr>
        </thead>
        <tbody>
          {% for adv in advances %}
          <tr>
            <td>#{{ adv.id }}</td>
            <td>{{ adv.employee.user.get_full_name }}</td>
            <td>{{ adv.project.name }}</td>
            <td>
              <strong>Requested:</strong> ₹{{ adv.amount }}<br>
              <strong>Final:</strong> ₹{{ adv.adjusted_amount|default:adv.amount }}
              {% if adv.adjusted_amount and adv.adjusted_amount != adv.amount %}
                <br><span class="badge bg-danger">Adjusted by ₹{{ adv.amount|floatformat:2|add:"-"|add:adv.adjusted_amount|floatformat:2 }}</span>
              {% endif %}
            </td>
            <td>{{ adv.purpose|default:"-"|truncatechars:50 }}</td>
            <td>{{ adv.date_requested|date:"d M Y" }}</td>
            <td>
              <span class="badge bg-success">
                Manager: {% if adv.approved_by_manager %}✓{% else %}✗{% endif %} | 
                Accountant: {% if adv.approved_by_accountant %}✓{% else %}✗{% endif %}
              </span>
            </td>
            <td>
              <a href="{% url 'accountmanager:settle-advance' adv.id %}" class="btn btn-sm btn-primary">
                Settle
              </a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="alert alert-info text-center">
      No advance requests ready for settlement.
    </div>
  {% endif %}

  <div class="mt-3">
    <a href="{% url 'accountmanager:dashboard' %}" class="btn btn-outline-secondary">
      ← Back to Dashboard
    </a>
  </div>
</div>
{% endblock %}

{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container py-4">

  <!-- Page Title -->
  <h2 class="mb-4 text-primary">Project Management Dashboard</h2>

  <!-- Add New Project Button and Modal -->
  <button class="btn btn-success mb-3" data-bs-toggle="modal" data-bs-target="#addProjectModal">
    <i class="fa fa-plus-circle"></i> Add New Project
  </button>

  <!-- Add New Task Button and Modal -->
  <button class="btn btn-info mb-3 ms-2" data-bs-toggle="modal" data-bs-target="#addTaskModal">
    <i class="fa fa-tasks"></i> Add Task
  </button>
  
						<form method="post" action="{% url 'accounts:profile' %}">
							{% csrf_token %}
							<button type="submit" class="btn btn-secondary btn-lg shadow-sm">
								<i class="bi bi-house me-2"></i>Dashboard
							</button>
						</form>

  <!-- Projects Overview -->
  {% for project in projects %}
  <div class="card mb-4 shadow-sm">
    <!-- Card Header -->
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
      <h5 class="mb-0">Project: {{ project.name }} | Customer: {{ project.customer_name }}</h5>
      {% if project.id %}
      <form method="POST" action="{% url 'project:delete-project' project.id %}" style="display: inline;">
        {% csrf_token %}
        <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure you want to delete this project?')">Delete Project</button>
      </form>
      {% endif %}
    </div>

    <div class="card-body">
      <p><strong>Customer:</strong> {{ project.customer_name }}</p>
      <p><strong>Description:</strong> {{ project.description }}</p>
      <p><strong>Location:</strong> {{ project.location }} {% if project.location == 'International' %} ({{ project.country }}, {{ project.currency }}){% endif %}</p>
      <p><strong>Duration:</strong> {{ project.start_date }} - {{ project.end_date }}</p>
      <p><strong>Status:</strong> {{ project.status }}</p>
      <p><strong>Budget:</strong> {{ project.currency }} {{ project.budget|default:"-" }}</p>

		{% if project.billing_method == 'daily' %}
		  <p><strong>Daily Rate:</strong> {{ project.currency }} {{ project.daily_hourly_rate|default:"-" }}</p>
		{% elif project.billing_method == 'hourly' %}
		  <p><strong>Hourly Rate:</strong> {{ project.currency }} {{ project.daily_hourly_rate|default:"-" }}</p>
		{% else %}
		  <p><strong>Rate:</strong> {{ project.currency }} {{ project.daily_hourly_rate|default:"-" }}</p>
		{% endif %}


      <!-- Tasks Table -->
      <table class="table table-bordered table-hover mt-3">
        <thead class="table-secondary">
          <tr>
            <th>#</th>
            <th>Task</th>
            <th>Due Date</th>
            <th>Progress</th>
            <th>Subtasks</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for task in project.tasks.all %}
          <tr>
            <td>{{ forloop.counter }}</td>
            <td>{{ task.name }}</td>
            <td>{{ task.due_date }}</td>
            <td>
              <div class="progress">
                <div class="progress-bar {% if task.due_date < today %}bg-danger{% else %}bg-success{% endif %}" style="width: {{ task.progress }}%;">
                  {{ task.progress }}%
                </div>
              </div>
            </td>
            <td>
              <ul>
                {% for subtask in task.subtasks.all %}
                  <li>{{ subtask.name }} {% if subtask.completed %}<span class="badge bg-success">Done</span>{% else %}<span class="badge bg-warning">Pending</span>{% endif %}</li>
                {% empty %}
                  <small>No Subtasks</small>
                {% endfor %}
              </ul>
            </td>
            <td>
              {% if task.id %}
                <a href="{% url 'project:edit-task' task.id %}" class="btn btn-sm btn-warning">Edit</a>
                <form method="POST" action="{% url 'project:delete-task' task.id %}" style="display: inline;">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Delete this task?')">Delete</button>
                </form>
              {% else %}
                <span class="text-muted">Not editable</span>
              {% endif %}
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="6">No tasks available.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% empty %}
    <p>No projects available. Please add a new project.</p>
  {% endfor %}
</div>

<!-- Modals Section -->

<!-- Add Project Modal -->
<div class="modal fade" id="addProjectModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <form method="post" enctype="multipart/form-data">
      {% csrf_token %}
      <input type="hidden" name="add_project" value="1">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title">Add New Project</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="project-form-fields">
			  {% for field in project_form %}
				<div class="mb-3" id="div_{{ field.name }}">
				  <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
				  {{ field }}
				</div>
			  {% endfor %}
		</div>

        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Add Project</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Add Task Modal -->
<div class="modal fade" id="addTaskModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <form method="post">
      {% csrf_token %}
      <input type="hidden" name="add_task" value="1">
      <div class="modal-content">
        <div class="modal-header bg-info text-white">
          <h5 class="modal-title">Add New Task</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          {{ task_form.as_p }}
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-info">Add Task</button>
        </div>
      </div>
    </form>
  </div>
</div>

{% endblock %}

{% block scripts %}

<script>
document.addEventListener("DOMContentLoaded", function () {
    function toggleFields() {
        const location = document.getElementById("id_location")?.value;
        const projectType = document.getElementById("id_project_type")?.value;

        // Toggle international fields
        const intlFields = ["div_id_country", "div_id_currency", "div_id_da_rate_per_hour", "div_id_extra_hour_rate"];
        intlFields.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.style.display = (location === "International") ? "block" : "none";
        });

        // Hide budget for Service project type
        const budgetDiv = document.getElementById("div_id_budget");
        if (budgetDiv) {
            budgetDiv.style.display = (projectType === "Service") ? "none" : "block";
        }
    }

    function updateDAFields() {
        const countrySelect = document.getElementById("id_country");
        const daRateField = document.getElementById("id_da_rate_per_hour");
        const extraHourRateField = document.getElementById("id_extra_hour_rate");

        const selectedOption = countrySelect.options[countrySelect.selectedIndex];
        const selectedText = selectedOption.text;

        if (selectedText.includes("USA")) {
            daRateField.value = "10.00";
            extraHourRateField.value = "12.00";
        } else if (selectedText.includes("Mexico")) {
            daRateField.value = "7.00";
            extraHourRateField.value = "10.00";
        } else if (selectedText.includes("UK")) {
            daRateField.value = "6.00";
            extraHourRateField.value = "9.00";
        }
    }

    document.getElementById("id_location")?.addEventListener("change", toggleFields);
    document.getElementById("id_project_type")?.addEventListener("change", toggleFields);
    document.getElementById("id_country")?.addEventListener("change", updateDAFields);

    toggleFields(); // Initial state
});
</script>

</script>
{% endblock %}

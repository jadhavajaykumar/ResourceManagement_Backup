{% extends "base.html" %}
{% load widget_tweaks %}
{% block content %}
<div class="container mt-4">

  {# Global messages #}
  {% if messages %}
    <div class="mb-2">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags|default:'info' }} mb-2" role="alert">
          {{ message }}
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <!-- Page header + primary actions -->
  <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
    <div>
      <h3 class="text-primary m-0">Unified Expense, Advance &amp; DA Dashboard</h3>
      <div class="text-muted small">A single place to submit, approve, and reconcile</div>
    </div>
    <div class="d-flex gap-2">
      <button class="btn btn-primary btn-sm" id="newExpenseBtn" data-bs-toggle="modal" data-bs-target="#expenseModal">
        + New Expense
      </button>

      {% if allow_new_advance %}
        <button class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#advanceModal">
          <i class="bi bi-cash-coin"></i> Raise Advance Request
        </button>
      {% else %}
        <button class="btn btn-secondary btn-sm" disabled>
          Balance: ₹{{ current_balance|floatformat:2 }}
        </button>
      {% endif %}

      <!-- Mobile filters trigger -->
      <button class="btn btn-outline-secondary btn-sm d-md-none" type="button"
              data-bs-toggle="offcanvas" data-bs-target="#filterOffcanvas" aria-controls="filterOffcanvas">
        <i class="bi bi-funnel"></i> Filters
      </button>
    </div>
  </div>

  <div class="row">
    <!-- LEFT SIDEBAR (sticky on desktop) -->
    <aside class="col-12 col-md-3 mb-3">
      <div class="d-none d-md-block">
        {% include "expenses/unified/partials/filter_form.html" %}
      </div>
    </aside>

    <!-- MAIN CONTENT -->
    <div class="col-12 col-md-9">

      <!-- Summary cards -->
      {% if advance_summary %}
      <div class="row g-3 mb-3">
        <div class="col-12 col-md-6 col-lg-3">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-body py-3">
              <div class="small text-muted">Advance Credited</div>
              <div class="h5 mb-0">₹{{ advance_summary.total_advance_amount|floatformat:2 }}</div>
            </div>
          </div>
        </div>
        <div class="col-12 col-md-6 col-lg-3">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-body py-3">
              <div class="small text-muted">Used Against Expenses</div>
              <div class="h5 mb-0">₹{{ advance_summary.total_deducted|floatformat:2 }}</div>
            </div>
          </div>
        </div>
        <div class="col-12 col-md-6 col-lg-3">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-body py-3">
              <div class="small text-muted">Advance Balance</div>
              <div class="h5 mb-0">₹{{ advance_summary.advance_balance|floatformat:2 }}</div>
            </div>
          </div>
        </div>
        <div class="col-12 col-md-6 col-lg-3">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-body py-3">
              <div class="small text-muted">Submitted (Awaiting Flow)</div>
              <div class="h5 mb-0">₹{{ advance_summary.submitted_total|floatformat:2 }}</div>
            </div>
          </div>
        </div>
      </div>
      {% endif %}

      <style>
        .seg { gap:.5rem; flex-wrap:wrap; }
        .seg .btn { border-radius: 999px; }
        .seg .btn.active { pointer-events:none; }
        @media (min-width: 768px){
          aside .card, aside .collapse, aside form { position: sticky; top: 70px; }
        }
      </style>

      <!-- Top-level tabs -->
      <ul class="nav nav-tabs mb-3" id="mainTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="tab-expenses" data-bs-toggle="tab" data-bs-target="#pane-expenses" type="button" role="tab">Expenses</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="tab-advances" data-bs-toggle="tab" data-bs-target="#pane-advances" type="button" role="tab">Advances</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="tab-da" data-bs-toggle="tab" data-bs-target="#pane-da" type="button" role="tab">DA</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="tab-reports" data-bs-toggle="tab" data-bs-target="#pane-reports" type="button" role="tab">Reports</button>
        </li>
        {% if is_account_manager %}
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-am" data-bs-toggle="tab" data-bs-target="#pane-am" type="button" role="tab">
              Settlement Summary
            </button>
          </li>
        {% endif %}
      </ul>

      <div class="tab-content">

        <!-- EXPENSES -->
        <div class="tab-pane fade show active" id="pane-expenses" role="tabpanel" aria-labelledby="tab-expenses">
          <div class="d-flex seg mb-2">
            <button class="btn btn-outline-secondary btn-sm active" data-expense-view="pending">
              Pending <span class="badge bg-secondary ms-1">{{ tabs.pending_expenses|length }}</span>
            </button>
            <button class="btn btn-outline-secondary btn-sm" data-expense-view="approved">
              Approved <span class="badge bg-secondary ms-1">{{ tabs.approved_expenses|length }}</span>
            </button>
            <button class="btn btn-outline-secondary btn-sm" data-expense-view="rejected">
              Rejected <span class="badge bg-secondary ms-1">{{ tabs.rejected_expenses|length }}</span>
            </button>
            <button class="btn btn-outline-secondary btn-sm" data-expense-view="settled">
              Settled <span class="badge bg-secondary ms-1">{{ tabs.settled_expenses|length }}</span>
            </button>
          </div>

          <div data-expense-panel="pending">
            {% include "expenses/unified/partials/table_expenses.html" with items=tabs.pending_expenses role=role action=expense_action %}
          </div>
          <div data-expense-panel="approved" class="d-none">
            {% include "expenses/unified/partials/table_expenses.html" with items=tabs.approved_expenses role=role action=expense_action %}
          </div>
          <div data-expense-panel="rejected" class="d-none">
            {% include "expenses/unified/partials/table_expenses.html" with items=tabs.rejected_expenses role=role action=expense_action %}
          </div>
          <div data-expense-panel="settled" class="d-none">
            {% include "expenses/unified/partials/table_expenses.html" with items=tabs.settled_expenses role=role action="none" %}
          </div>
        </div>

        <!-- ADVANCES -->
        <div class="tab-pane fade" id="pane-advances" role="tabpanel" aria-labelledby="tab-advances">
          <div class="d-flex seg mb-2">
            <button class="btn btn-outline-secondary btn-sm active" data-advance-view="pending">
              Pending <span class="badge bg-secondary ms-1">{{ tabs.pending_advances|length }}</span>
            </button>
            <button class="btn btn-outline-secondary btn-sm" data-advance-view="approved">
              Forwarded to AM <span class="badge bg-secondary ms-1">{{ tabs.approved_advances|length }}</span>
            </button>
            <button class="btn btn-outline-secondary btn-sm" data-advance-view="rejected">
              Rejected <span class="badge bg-secondary ms-1">{{ tabs.rejected_advances|length }}</span>
            </button>
            <button class="btn btn-outline-secondary btn-sm" data-advance-view="settled">
              Settled <span class="badge bg-secondary ms-1">{{ tabs.settled_advances|length }}</span>
            </button>
          </div>

          <div data-advance-panel="pending">
            {% include "expenses/unified/partials/table_advances.html" with items=tabs.pending_advances role=role action=expense_action %}
          </div>
          <div data-advance-panel="approved" class="d-none">
            {% include "expenses/unified/partials/table_advances.html" with items=tabs.approved_advances role=role action=expense_action %}
          </div>
          <div data-advance-panel="rejected" class="d-none">
            {% include "expenses/unified/partials/table_advances.html" with items=tabs.rejected_advances role=role action=expense_action %}
          </div>
          <div data-advance-panel="settled" class="d-none">
            {% include "expenses/unified/partials/table_advances.html" with items=tabs.settled_advances role=role action="none" %}
          </div>
        </div>

        <!-- DA -->
        <div class="tab-pane fade" id="pane-da" role="tabpanel" aria-labelledby="tab-da">
          <div class="d-flex seg mb-2">
            <button class="btn btn-outline-secondary btn-sm active" data-da-view="pending">
              Pending DA <span class="badge bg-secondary ms-1">{{ tabs.pending_da|length }}</span>
            </button>
            <button class="btn btn-outline-secondary btn-sm" data-da-view="approved">
              Approved DA <span class="badge bg-secondary ms-1">{{ tabs.approved_da|length }}</span>
            </button>
            <button class="btn btn-outline-secondary btn-sm" data-da-view="settled">
              Settled DA <span class="badge bg-secondary ms-1">{{ tabs.settled_da|length }}</span>
            </button>
          </div>

          <div data-da-panel="pending">
            {% include "expenses/unified/partials/table_da.html" with items=tabs.pending_da role=role viewer_role=viewer_role show_actions=is_reviewer show_settlement=False %}
          </div>

          <div data-da-panel="approved" class="d-none">
            {% include "expenses/unified/partials/table_da.html" with items=tabs.approved_da role=role viewer_role=viewer_role show_actions=False show_settlement=False %}
          </div>

          <div data-da-panel="settled" class="d-none">
            {% include "expenses/unified/partials/table_da.html" with items=tabs.settled_da role=role viewer_role=viewer_role show_actions=False show_settlement=True %}
          </div>
        </div>

        <!-- REPORTS -->
        <div class="tab-pane fade" id="pane-reports" role="tabpanel" aria-labelledby="tab-reports">
          <div class="card border-0 shadow-sm">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
                <div>
                  <h6 class="m-0">Generate Report</h6>
                  <small class="text-muted">Export Expenses, Advances, DA &amp; Adjustments with summaries</small>
                </div>
              </div>

              <form class="row g-2 align-items-end" method="get" action="{% url 'expenses:export-report' %}">
                <div class="col-6 col-md-3">
                  <label class="form-label">From</label>
                  <input type="date" name="from" class="form-control" required>
                </div>
                <div class="col-6 col-md-3">
                  <label class="form-label">To</label>
                  <input type="date" name="to" class="form-control" required>
                </div>

                {% if role != "Employee" %}
                  <div class="col-6 col-md-3">
                    <label class="form-label">Project</label>
                    <select name="project" class="form-select">
                      <option value="">All</option>
                      {% for p in projects %}
                        <option value="{{ p.project_id }}">{{ p.project__name }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  {% if employees %}
                  <div class="col-6 col-md-3">
                    <label class="form-label">Employee</label>
                    <select name="employee" class="form-select">
                      <option value="">All</option>
                      {% for emp in employees %}
                        <option value="{{ emp.id }}">{{ emp.user.get_full_name }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  {% endif %}
                {% else %}
                  <input type="hidden" name="employee" value="{{ request.user.employeeprofile.id }}">
                  <div class="col-12">
                    <div class="alert alert-info py-2 mb-2">
                      You can export only your own records.
                    </div>
                  </div>
                {% endif %}

                <div class="col-12">
                  <div class="d-flex flex-wrap gap-2">
                    <label class="form-check">
                      <input class="form-check-input" type="checkbox" name="include_expenses" checked>
                      <span class="form-check-label">Expenses</span>
                    </label>
                    <label class="form-check">
                      <input class="form-check-input" type="checkbox" name="include_advances" checked>
                      <span class="form-check-label">Advances</span>
                    </label>
                    <label class="form-check">
                      <input class="form-check-input" type="checkbox" name="include_da" checked>
                      <span class="form-check-label">DA</span>
                    </label>
                    <label class="form-check">
                      <input class="form-check-input" type="checkbox" name="include_adjustments" checked>
                      <span class="form-check-label">Advance Adjustments</span>
                    </label>
                  </div>
                </div>

                <div class="col-12 d-flex flex-wrap gap-2 mt-2">
                  <button type="submit" name="fmt" value="pdf" class="btn btn-outline-primary btn-sm">
                    <i class="bi bi-file-earmark-pdf"></i> Export PDF
                  </button>
                </div>
              </form>

              <hr class="my-3">

              <div class="small text-muted">
                The XLSX includes multiple sheets: <strong>Summary</strong>, <strong>Expenses</strong>,
                <strong>Advances</strong>, <strong>DA</strong>, <strong>Adjustments</strong> (with reviewer/remarks).
              </div>
            </div>
          </div>
        </div>

        {% if is_account_manager %}
          <div class="tab-pane fade" id="pane-am" role="tabpanel" aria-labelledby="tab-am">
            <div class="card border-0 shadow-sm">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <h6 class="m-0">Account Manager – Settlement Summary</h6>
                </div>
                {% include "expenses/unified/partials/settlement_summary.html" with items=am_settlement_summary %}
              </div>
            </div>
          </div>
        {% endif %}

      </div>
    </div>
  </div>

  <!-- Offcanvas (mobile filters) -->
  <div class="offcanvas offcanvas-start" tabindex="-1" id="filterOffcanvas">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title">Filters</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
      {% include "expenses/unified/partials/filter_form.html" %}
    </div>
  </div>

  <!-- EXPENSE MODAL -->
  <div class="modal fade" id="expenseModal" tabindex="-1" aria-labelledby="expenseModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content p-3">
        <h5 class="modal-title mb-3" id="expenseModalLabel">Submit Expense</h5>
        <form method="post" enctype="multipart/form-data" id="expenseForm">
          {% csrf_token %}
          <div id="expense-form-body">
            {% include "expenses/expense_form_partial.html" with form=expense_form editing=False %}
          </div>
          <div class="mt-3 text-end">
            <button type="submit" name="submit_expense" value="1" class="btn btn-primary">Submit Expense</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- ADVANCE MODAL & INFO -->
  {% if not allow_new_advance %}
    <div class="alert alert-info mt-2">
      <strong>Info:</strong> You cannot raise a new advance request until your current balance (₹{{ current_balance|floatformat:2 }}) is cleared.
    </div>
  {% else %}
    <div class="modal fade" id="advanceModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content p-3">
          <h5 class="modal-title mb-3" id="advanceModalLabel">
            <i class="bi bi-cash-stack me-2"></i> Raise Advance Request
          </h5>

          {% if latest_advance == None %}
            <form method="post" id="advanceForm">
              {% csrf_token %}
              <div id="advance-form-body">
                {% include "expenses/advance_form_partial.html" with form=advance_form editing=False %}
              </div>
              <div class="mt-3 text-end">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" name="submit_advance" value="1" class="btn btn-warning" id="advanceSubmitBtn">Submit Request</button>
              </div>
            </form>

          {% elif latest_advance.status == "Submitted" and latest_advance.current_stage == "MANAGER" %}
            <form method="post" id="advanceForm">
              {% csrf_token %}
              <div id="advance-form-body">
                {% include "expenses/advance_form_partial.html" with form=advance_form editing=False %}
              </div>
              <div class="mt-3 text-end">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" name="submit_advance" value="1" class="btn btn-warning" id="advanceSubmitBtn">Submit Request</button>
              </div>
            </form>

          {% elif latest_advance.status == "Settled" %}
            <form method="post" id="advanceForm">
              {% csrf_token %}
              <div id="advance-form-body">
                {% include "expenses/advance_form_partial.html" with form=advance_form editing=False %}
              </div>
              <div class="mt-3 text-end">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" name="submit_advance" value="1" class="btn btn-warning" id="advanceSubmitBtn">Submit Request</button>
              </div>
            </form>

          {% else %}
            <div class="alert alert-warning mb-0">
              <strong>Advance Locked:</strong>
              Current advance is at <em>{{ latest_advance.current_stage }}</em> stage ({{ latest_advance.status }}).
              You cannot raise a new request now.
            </div>
            <div class="mt-3 text-end">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  {% endif %}

</div>

<!-- Page JS -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  // EXPENSE form modal & dynamic load
  const expenseModalEl = document.getElementById('expenseModal');
  const expenseModal = expenseModalEl ? new bootstrap.Modal(expenseModalEl) : null;
  const modalTitle   = document.getElementById('expenseModalLabel');
  const formBody     = document.getElementById('expense-form-body');
  const expenseForm  = document.getElementById('expenseForm');

  const setSubmitBtn = (text, nameValueOrNull) => {
    const btn = expenseForm.querySelector("button[type='submit']");
    if (!btn) return;
    btn.textContent = text;
    if (nameValueOrNull) {
      btn.setAttribute("name", nameValueOrNull);
      btn.setAttribute("value", "1");
    } else {
      btn.removeAttribute("name");
      btn.removeAttribute("value");
    }
  };

  const newBtn = document.getElementById("newExpenseBtn");
  if (newBtn) {
    newBtn.addEventListener("click", function() {
      if (modalTitle) modalTitle.textContent = "Submit Expense";
      fetch("{% url 'expenses:new-expense-form' %}")
        .then(res => res.json())
        .then(data => {
          formBody.innerHTML = data.form_html;
          expenseForm.action = "{{ request.path }}";
          setSubmitBtn("Submit Expense", "submit_expense");
          if (typeof initExpenseForm === "function") { initExpenseForm(); }
        })
        .catch(err => console.error("Error loading new expense form:", err));
    });
  }

  document.querySelectorAll(".edit-expense-btn").forEach(btn => {
    btn.addEventListener("click", function () {
      const expenseId = this.dataset.expenseId;
      if (modalTitle) modalTitle.textContent = "Edit Expense";

      const jsonUrl = "{% url 'expenses:edit-expense-json' 0 %}".replace("/0/", `/${expenseId}/`);
      const postUrl = "{% url 'expenses:edit-expense' 0 %}".replace("/0/", `/${expenseId}/`);

      fetch(jsonUrl)
        .then(res => res.json())
        .then(data => {
          if (data.error) { alert(data.error); return; }
          formBody.innerHTML = data.form_html;
          expenseForm.action = postUrl;
          setSubmitBtn("Update Expense", null);
          if (typeof initExpenseForm === "function") { initExpenseForm(); }
        })
        .catch(err => console.error("Error loading edit expense form:", err));

      if (expenseModal) expenseModal.show();
    });
  });

  // ADVANCE edit modal wiring
  const advanceModalEl = document.getElementById('advanceModal');
  const advanceModal   = advanceModalEl ? new bootstrap.Modal(advanceModalEl) : null;
  const advTitle       = document.getElementById('advanceModalLabel');
  const advanceFormEl  = document.getElementById('advanceForm');
  const advFormBody    = document.getElementById('advance-form-body');
  const advSubmitBtn   = document.getElementById('advanceSubmitBtn');

  document.querySelectorAll(".edit-advance-btn").forEach(btn => {
    btn.addEventListener("click", function () {
      if (!advanceModal) return;
      const advanceId = this.dataset.advanceId;
      if (advTitle) advTitle.innerHTML = `<i class="bi bi-cash-stack me-2"></i> Edit Advance Request`;

      const editUrl = "{% url 'expenses:edit-advance-json' 0 %}".replace("/0/", `/${advanceId}/`);

      fetch(editUrl)
        .then(res => res.json())
        .then(data => {
          if (data.error) { alert(data.error); return; }
          if (advFormBody) advFormBody.innerHTML = data.form_html;
          if (advanceFormEl) advanceFormEl.action = editUrl.replace("/json/", "/");
          if (advSubmitBtn) advSubmitBtn.textContent = "Update Advance";
        })
        .catch(err => console.error("Error loading edit advance form:", err));

      advanceModal.show();
    });
  });

  // Sub-filters for Expenses
  document.querySelectorAll("[data-expense-view]").forEach(btn => {
    btn.addEventListener("click", function () {
      document.querySelectorAll("[data-expense-view]").forEach(b => b.classList.remove("active"));
      this.classList.add("active");
      const target = this.getAttribute("data-expense-view");
      document.querySelectorAll("[data-expense-panel]").forEach(p => {
        p.classList.toggle("d-none", p.getAttribute("data-expense-panel") !== target);
      });
    });
  });

  // Sub-filters for Advances
  document.querySelectorAll("[data-advance-view]").forEach(btn => {
    btn.addEventListener("click", function () {
      document.querySelectorAll("[data-advance-view]").forEach(b => b.classList.remove("active"));
      this.classList.add("active");
      const target = this.getAttribute("data-advance-view");
      document.querySelectorAll("[data-advance-panel]").forEach(p => {
        p.classList.toggle("d-none", p.getAttribute("data-advance-panel") !== target);
      });
    });
  });

  // Sub-filters for DA
  document.querySelectorAll("[data-da-view]").forEach(btn => {
    btn.addEventListener("click", function () {
      document.querySelectorAll("[data-da-view]").forEach(b => b.classList.remove("active"));
      this.classList.add("active");
      const target = this.getAttribute("data-da-view");
      document.querySelectorAll("[data-da-panel]").forEach(p => {
        p.classList.toggle("d-none", p.getAttribute("data-da-panel") !== target);
      });
    });
  });

  // Tooltips
  const tipTriggers = document.querySelectorAll('[data-bs-toggle="tooltip"]');
  tipTriggers.forEach(el => new bootstrap.Tooltip(el));
});
</script>

{# Auto-open modals when form errors occurred #}
{% if show_expense_modal %}
<script>
document.addEventListener("DOMContentLoaded", function () {
  var el = document.getElementById('expenseModal');
  if (el) { bootstrap.Modal.getOrCreateInstance(el).show(); }
});
</script>
{% endif %}
{% if show_advance_modal %}
<script>
document.addEventListener("DOMContentLoaded", function () {
  var el = document.getElementById('advanceModal');
  if (el) { bootstrap.Modal.getOrCreateInstance(el).show(); }
});
</script>
{% endif %}

{% endblock %}

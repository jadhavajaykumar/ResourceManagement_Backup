{% load widget_tweaks %}

<div class="card mb-4">
    <div class="card-body">
        <div class="row g-3">

            <!-- Project -->
            <div class="col-md-6">
                <label for="{{ form.project.id_for_label }}" class="form-label">Project</label>
                {{ form.project|add_class:"form-select" }}
                {{ form.project.errors }}
            </div>

            <!-- Expense Type -->
            <div class="col-md-6">
                <label for="id_new_expense_type" class="form-label">Expense Type</label>
                <select name="{{ form.new_expense_type.name }}"
                        id="id_new_expense_type"
                        class="form-select"
                        required>
                    <option value="">-- Select Expense Type --</option>
                    {% for type in form.new_expense_type.field.queryset %}
                        <option value="{{ type.id }}"
                            data-requires-km="{{ type.requires_kilometers|yesno:'true,false' }}"
                            data-requires-receipt="{{ type.requires_receipt|yesno:'true,false' }}"
                            data-rate="{{ type.rate_per_km|default:0 }}"
                            data-requires-travel="{{ type.requires_travel_locations|yesno:'true,false' }}"
                            data-max-cap="{{ type.max_amount_allowed|default:0 }}"
                            {% if form.new_expense_type.value|stringformat:'s' == type.id|stringformat:'s' %}selected{% endif %}>
                            {{ type.name }}
                        </option>
                    {% endfor %}
                </select>
                {{ form.new_expense_type.errors }}
            </div>

            <!-- Travel Fields -->
            <div class="col-md-6" id="travel-fields-from" style="display:none;">
                <label for="{{ form.from_location.id_for_label }}" class="form-label">From Location</label>
                {{ form.from_location|add_class:"form-control" }}
                {{ form.from_location.errors }}
            </div>

            <div class="col-md-6" id="travel-fields-to" style="display:none;">
                <label for="{{ form.to_location.id_for_label }}" class="form-label">To Location</label>
                {{ form.to_location|add_class:"form-control" }}
                {{ form.to_location.errors }}
            </div>

            <!-- Date -->
            <div class="col-md-4">
                <label for="{{ form.date.id_for_label }}" class="form-label">Date</label>
                {{ form.date|add_class:"form-control" }}
                {{ form.date.errors }}
            </div>

            <!-- Distance (KM) -->
            <div class="col-md-4" id="kilometersField" style="display: none;">
                <label for="id_kilometers" class="form-label">Kilometers</label>
                {{ form.kilometers|add_class:"form-control" }}
                {{ form.kilometers.errors }}
            </div>

            <!-- Amount -->
            <div class="col-md-4" id="amountField">
                <label for="id_amount" class="form-label" id="amountLabel">Amount (₹)</label>
                {{ form.amount|add_class:"form-control" }}
                {{ form.amount.errors }}
            </div>

            <!-- Receipt Upload -->
            <div class="col-md-6">
                <label for="{{ form.receipt.id_for_label }}" class="form-label">Upload Receipt</label>
                {{ form.receipt|add_class:"form-control" }}
                {{ form.receipt.errors }}
                {% if editing and form.instance.receipt %}
                    <div class="mt-2">
                        <a href="{{ form.instance.receipt.url }}" target="_blank">View Existing Receipt</a>
                    </div>
                {% endif %}
            </div>

            <!-- Comments -->
            <div class="col-md-6">
                <label for="{{ form.comments.id_for_label }}" class="form-label">Comments</label>
                {{ form.comments|add_class:"form-control" }}
                <div style="max-height: 100px; overflow-y: auto;">
                    {{ form.comments.errors }}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function initExpenseForm() {
    const expenseType = document.getElementById('id_new_expense_type');
    const kilometersField = document.getElementById('kilometersField');
    const amountField = document.getElementById('amountField');
    const amountInput = document.getElementById('id_amount');
    const kilometersInput = document.getElementById('id_kilometers');
    const receiptInput = document.getElementById('id_receipt');
    const travelFromField = document.getElementById('travel-fields-from');
    const travelToField = document.getElementById('travel-fields-to');

    function updateFormFields() {
        const selected = expenseType.options[expenseType.selectedIndex];
        if (!selected) return;

        const requiresKm = selected.dataset.requiresKm === 'true';
        const requiresReceipt = selected.dataset.requiresReceipt === 'true';
        const requiresTravel = selected.dataset.requiresTravel === 'true';
        const rate = parseFloat(selected.dataset.rate || 0);

        kilometersField.style.display = requiresKm ? 'block' : 'none';
        amountField.style.display = requiresKm ? 'none' : 'block';
        travelFromField.style.display = requiresTravel ? 'block' : 'none';
        travelToField.style.display = requiresTravel ? 'block' : 'none';
        receiptInput.required = requiresReceipt;

        if (requiresKm && kilometersInput.value) {
            amountInput.value = (kilometersInput.value * rate).toFixed(2);
        }
    }

    function enforceMaxCap() {
        const selected = expenseType.options[expenseType.selectedIndex];
        const maxCap = parseFloat(selected.dataset.maxCap || 0);
        if (maxCap > 0 && parseFloat(amountInput.value) > maxCap) {
            alert(`Maximum allowed amount for this expense is ₹${maxCap}`);
            amountInput.value = maxCap.toFixed(2);
        }
    }

    expenseType.addEventListener('change', updateFormFields);
    kilometersInput.addEventListener('input', updateFormFields);
    amountInput.addEventListener('blur', enforceMaxCap);

    updateFormFields(); // Ensure proper field visibility in edit mode
}
initExpenseForm();

	document.addEventListener("DOMContentLoaded", function () {
		initExpenseForm();

		{% if editing and requires_km %}
			// Force KM field visible & amount hidden in edit mode
			document.getElementById('kilometersField').style.display = 'block';
			document.getElementById('amountField').style.display = 'none';
		{% endif %}
	});
</script>



{# templates/expenses/expense_form_partial.html #}
{% load i18n %}
{# Renders the form. Assumes widget attrs (id, placeholder, title, aria-label, class) are set by the view or form. #}

<div class="row g-3">
  {# Non-field errors #}
  {% if form.non_field_errors %}
    <div class="col-12">
      <div class="alert alert-danger">
        {% for e in form.non_field_errors %}
          {{ e }}{% if not forloop.last %}<br>{% endif %}
        {% endfor %}
      </div>
    </div>
  {% endif %}

  {# Render each field. Special-case new_expense_type so we can output data-* attrs per option. #}
  {% for field in form %}
    {% if field.is_hidden %}
      <div class="d-none">
        {{ field }}
      </div>
    {% else %}
      {% if field.name == 'new_expense_type' %}
        <div class="col-12">
          <label for="{{ field.id_for_label }}" class="form-label">
            {{ field.label|default:field.name|capfirst }}
          </label>

          {# Custom select so we can attach data- attributes to each option. #}
          <select name="{{ field.html_name }}" id="{{ field.id_for_label }}"
                  class="{{ field.field.widget.attrs.class|default:'form-select' }}">
            <option value="">{% trans "Choose..." %}</option>
            {% for et in field.field.queryset %}
              <option value="{{ et.id }}"
                data-requires-km="{{ et.requires_kilometers|yesno:'true,false' }}"
                data-rate="{{ et.rate_per_km|default:0 }}"
                data-requires-receipt="{{ et.requires_receipt|yesno:'true,false' }}"
                data-requires-travel="{{ et.requires_travel_locations|yesno:'true,false' }}"
                data-max-cap="{{ et.max_amount_allowed|default:'' }}"
                data-timesheet-required="{{ et.timesheet_required|yesno:'true,false' }}"
                {% if field.value|stringformat:"s" == et.id|stringformat:"s" %}selected{% endif %}>
                {{ et.name }}
              </option>
            {% endfor %}
          </select>

          {% if field.help_text %}
            <div class="form-text small">{{ field.help_text }}</div>
          {% endif %}

          {% for err in field.errors %}
            <div class="text-danger small">{{ err }}</div>
          {% endfor %}
        </div>
      {% else %}
        <div class="col-12">
          <label for="{{ field.id_for_label }}" class="form-label">
            {{ field.label|default:field.name|capfirst }}
          </label>

          {{ field }}

          {% if field.help_text %}
            <div class="form-text small">{{ field.help_text }}</div>
          {% endif %}

          {% for err in field.errors %}
            <div class="text-danger small">{{ err }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endif %}
  {% endfor %}
</div>

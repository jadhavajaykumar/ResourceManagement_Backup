{# expenses/unified/partials/table_da.html #}


<table class="table table-bordered table-sm align-middle">
  <thead class="table-light">
    <tr>
      <th>Date</th>
      <th>Employee</th>
      <th>Project</th>
      <th>DA Amount</th>
      <th>Currency</th>
      <th>Status</th>
      {% if show_settlement %}
        <th>Settlement Method</th>
        <th>Settlement Date</th>
        <th>Settled Amount</th>
      {% endif %}
      <th class="text-end">Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for da in items %}
      {# Highlight entitlement rows (weekend + auto + no timesheet) #}
      <tr
        {% if da.is_weekend and da.auto_generated and not da.timesheet %}
          class="table-warning"
        {% endif %}
      >
        <td>{{ da.date|date:"M j, Y (D)" }}</td>
        <td>{{ da.employee.user.get_full_name }}</td>
        <td>{{ da.project.name }}</td>
        <td>{{ da.da_amount }}</td>
        <td>{{ da.currency }}</td>

        <!-- Status -->
        <td>
          {% if da.is_weekend and da.auto_generated and not da.timesheet %}
            <span class="badge bg-info">Weekend</span>
          {% endif %}

          {% if da.reimbursed or da.settlement_date %}
            <span class="badge bg-primary">Settled</span>
          {% elif da.rejected %}
            <span class="badge bg-danger">Rejected</span>
          {% elif da.approved %}
            <span class="badge bg-success">Approved</span>
          {% else %}
            <span class="badge bg-warning text-dark">Pending</span>
          {% endif %}
        </td>

        {% if show_settlement %}
          <td>
            {% if da.settlement_method %}
              {{ da.settlement_method }}
            {% else %}
              —
            {% endif %}
          </td>
          <td>
            {% if da.settlement_date %}
              {{ da.settlement_date|date:"Y-m-d" }}
            {% else %}
              —
            {% endif %}
          </td>
          <td>
            {% if da.settled_amount %}
              {{ da.settled_amount }}
            {% else %}
              —
            {% endif %}
          </td>
        {% endif %}

        <!-- Actions -->
        <td class="text-end">
          {% if show_actions %}
            {% if da.is_weekend and da.auto_generated and not da.timesheet %}
              {# Manager-only actions for weekend auto entries #}
              {% if viewer_role == 'Manager' %}
                {% if not da.approved and not da.rejected %}
                  <form method="post" action="{% url 'expenses:da_weekend_approve' da.id %}" class="d-inline">
                    {% csrf_token %}
                    <input type="hidden" name="next" value="{% url 'expenses:unified-expense-dashboard' %}?tab=da">
                    <button class="btn btn-sm btn-success">Approve</button>
                  </form>
                  <form method="post" action="{% url 'expenses:da_weekend_reject' da.id %}" class="d-inline">
                    {% csrf_token %}
                    <input type="hidden" name="next" value="{% url 'expenses:unified-expense-dashboard' %}?tab=da">
                    <button class="btn btn-sm btn-outline-danger">Reject</button>
                  </form>
                  <form method="post" action="{% url 'expenses:da_weekend_delete' da.id %}" class="d-inline">
                    {% csrf_token %}
                    <input type="hidden" name="next" value="{% url 'expenses:unified-expense-dashboard' %}?tab=da">
                    <button class="btn btn-sm btn-outline-secondary">Delete</button>
                  </form>
                {% endif %}
              {% elif viewer_role == 'Accountant' %}
                {% if not da.approved and not da.rejected %}
                  <form method="post" action="{% url 'expenses:da_weekend_delete' da.id %}" class="d-inline">
                    {% csrf_token %}
                    <input type="hidden" name="next" value="{% url 'expenses:unified-expense-dashboard' %}?tab=da">
                    <button class="btn btn-sm btn-outline-secondary">Delete</button>
                  </form>
                {% endif %}
              {% endif %}
            {% endif %}
          {% endif %}
        </td>
      </tr>
    {% empty %}
      <tr>
        <td colspan="{% if show_settlement %}10{% else %}7{% endif %}" class="text-center text-muted">No DA records found.</td>
      </tr>
    {% endfor %}
  </tbody>
</table>

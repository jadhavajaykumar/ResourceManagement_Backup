{# expenses/unified/partials/settlement_summary.html #}
{% if not items %}
  <div class="alert alert-info mb-0">
    No approved & unsettled expenses/DA found for the current filters.
  </div>
{% else %}
  <div class="accordion" id="amSettleAcc">
    {% for row in items %}
      {% with emp=row.employee %}
      <div class="accordion-item">
        <h2 class="accordion-header" id="am-h-{{ emp.id }}">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                  data-bs-target="#am-c-{{ emp.id }}" aria-expanded="false" aria-controls="am-c-{{ emp.id }}">
            <div class="w-100 d-flex justify-content-between align-items-center">
              <div>
                <strong>{{ emp.user.get_full_name }}</strong>
                <small class="text-muted ms-2">ID: {{ emp.id }}</small>
              </div>
              <div class="text-end">
                <div class="fw-semibold">Total: ₹{{ row.grand_total|floatformat:2 }}</div>
                <small class="text-muted">
                  Expenses ₹{{ row.expenses_total|floatformat:2 }} &middot;
                  DA ₹{{ row.da_total|floatformat:2 }}
                </small>
              </div>
            </div>
          </button>
        </h2>
        <div id="am-c-{{ emp.id }}" class="accordion-collapse collapse" aria-labelledby="am-h-{{ emp.id }}" data-bs-parent="#amSettleAcc">
          <div class="accordion-body">
            {# Expenses list (Approved & Unsettled) #}
            <h6 class="mb-2">Expenses (Approved & Unsettled)</h6>
            {% if row.expenses %}
              <div class="table-responsive">
                <table class="table table-sm table-bordered align-middle mb-2">
                  <thead class="table-light">
                    <tr>
                      <th style="width: 110px;">Date</th>
                      <th>Project</th>
                      <th>Type</th>
                      <th class="text-end" style="width: 130px;">Amount</th>
                      <th>Receipt</th>
                      <th>From</th>
                      <th>To</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for e in row.expenses %}
                      <tr>
                        <td>{{ e.date|date:"Y-m-d" }}</td>
                        <td>{{ e.project.name }}</td>
                        <td>
                          {% if e.new_expense_type %}
                            {{ e.new_expense_type.name }}
                          {% else %}
                            <span class="text-muted">—</span>
                          {% endif %}
                        </td>
                        <td class="text-end">₹{{ e.amount|floatformat:2 }}</td>
                        <td>
                          {% if e.receipt %}
                            <a href="{{ e.receipt.url }}" target="_blank">View</a>
                          {% else %}
                            <span class="text-muted">—</span>
                          {% endif %}
                        </td>
                        <td>{% if e.from_location %}{{ e.from_location }}{% else %}<span class="text-muted">—</span>{% endif %}</td>
                        <td>{% if e.to_location %}{{ e.to_location }}{% else %}<span class="text-muted">—</span>{% endif %}</td>
                      </tr>
                    {% endfor %}
                    <tr class="table-light">
                      <th colspan="3" class="text-end">Subtotal (Expenses)</th>
                      <th class="text-end">₹{{ row.expenses_total|floatformat:2 }}</th>
                      <th colspan="3"></th>
                    </tr>
                  </tbody>
                </table>
              </div>
            {% else %}
              <div class="text-muted mb-2">No expenses in this batch.</div>
            {% endif %}

            {# DA list #}
            <h6 class="mb-2 mt-3">Daily Allowance (Approved & Unreimbursed)</h6>
            {% if row.da_list %}
              <div class="table-responsive">
                <table class="table table-sm table-bordered align-middle mb-2">
                  <thead class="table-light">
                    <tr>
                      <th style="width: 110px;">Date</th>
                      <th>Project</th>
                      <th class="text-end" style="width: 130px;">DA Amount</th>
                      <th>Flags</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for d in row.da_list %}
                      <tr {% if d.is_weekend and d.auto_generated and not d.timesheet %}class="table-warning"{% endif %}>
                        <td>{{ d.date|date:"Y-m-d" }}</td>
                        <td>{{ d.project.name }}</td>
                        <td class="text-end">₹{{ d.da_amount|floatformat:2 }}</td>
                        <td class="small">
                          {% if d.is_weekend %}<span class="badge bg-info">Weekend</span>{% endif %}
                          {% if d.auto_generated and not d.timesheet %}<span class="badge bg-secondary">Entitlement</span>{% endif %}
                        </td>
                      </tr>
                    {% endfor %}
                    <tr class="table-light">
                      <th colspan="2" class="text-end">Subtotal (DA)</th>
                      <th class="text-end">₹{{ row.da_total|floatformat:2 }}</th>
                      <th></th>
                    </tr>
                  </tbody>
                </table>
              </div>
            {% else %}
              <div class="text-muted mb-2">No DA in this batch.</div>
            {% endif %}

            <div class="d-flex justify-content-between align-items-center mt-3">
              <div class="fw-semibold">Grand Total: ₹{{ row.grand_total|floatformat:2 }}</div>

              <form method="post" action="{% url 'expenses:am-bulk-settle-employee' emp.id %}" class="d-inline">
                {% csrf_token %}
                <input type="hidden" name="next" value="{% url 'expenses:unified-expense-dashboard' %}?tab=am">
                <button class="btn btn-sm btn-primary">
                  Settle This Employee
                </button>
              </form>

            </div>
          </div>
        </div>
      </div>
      {% endwith %}
    {% endfor %}
  </div>
{% endif %}

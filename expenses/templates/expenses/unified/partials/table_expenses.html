<table class="table table-bordered table-sm mt-2">
  <thead class="table-light">
    <tr>
      <th>Date</th>
      <th>Employee</th>
      <th>Project</th>
      <th>Type</th>
      <th>Amount</th>
      <th>Advance Applied</th>
      <th>Receipt</th>
      <th>From</th>
      <th>To</th>
      <th>Status</th>
      <th>Remark</th>
      {% if action != "none" %}
        <th>Actions</th>
      {% endif %}
    </tr>
  </thead>
  <tbody>
    {% for exp in items %}
    <tr>
      <td>{{ exp.date }}</td>
      <td>{{ exp.employee.user.get_full_name }}</td>
      <td>{{ exp.project.name }}</td>
      <td>{{ exp.new_expense_type.name }}</td>
      <td>
        {% if exp.new_expense_type.requires_kilometers %}
          ₹{{ exp.amount }}
          <small class="text-muted">
            ({{ exp.kilometers }} km @ ₹{{ exp.new_expense_type.rate_per_km }}/km)
          </small>
        {% else %}
          ₹{{ exp.amount }}
        {% endif %}
      </td>

      <td>
        {% with adj=exp.advanceadjustmentlog_set.all|first %}
          {% if exp.reimbursed and exp.advance_used %}
            <span class="badge bg-success">Settled via Advance</span>
          {% elif exp.reimbursed and adj %}
            <span class="badge bg-success">Settled via Advance</span>
          {% elif exp.status == "Settled" %}
            <span class="badge bg-success">Settled</span>
          {% elif exp.status == "Approved" and not exp.reimbursed %}
            <span class="badge bg-warning text-dark">Approved (Cash Pending)</span>
          {% else %}
            {{ exp.status }}
          {% endif %}
        {% endwith %}
      </td>

      <td>
        {% if exp.receipt %}
          <a href="{{ exp.receipt.url }}" target="_blank" class="btn btn-outline-secondary btn-sm">View</a>
        {% elif exp.bill %}
          <a href="{{ exp.bill.url }}" target="_blank" class="btn btn-outline-secondary btn-sm">View</a>
        {% else %}
          <span class="text-muted">—</span>
        {% endif %}
      </td>

      <td>{{ exp.from_location|default:"–" }}</td>
      <td>{{ exp.to_location|default:"–" }}</td>

      <td>
        {% if exp.status == "Settled via Advance" %}
          <span class="badge bg-success">Settled via Advance</span>
        {% elif exp.status == "Approved" and not exp.reimbursed %}
          <span class="badge bg-warning text-dark">Approved (Cash Pending)</span>
        {% else %}
          {{ exp.status }}
        {% endif %}
      </td>

      <td>
        {% if exp.accountant_remark %}
          <div><small class="text-muted">Accountant:</small> {{ exp.accountant_remark }}</div>
        {% endif %}
        {% if exp.manager_remark %}
          <div><small class="text-muted">Manager:</small> {{ exp.manager_remark }}</div>
        {% endif %}
        {% if exp.account_manager_remark %}
          <div><small class="text-muted">Account&nbsp;Manager:</small> {{ exp.account_manager_remark }}</div>
        {% endif %}
        {% if not exp.accountant_remark and not exp.manager_remark and not exp.account_manager_remark %}
          {{ exp.comments|default:"–" }}
        {% endif %}
      </td>

      {% if action != "none" %}
      <td>

        {# Decide visibility: legacy exp.can_approve OR assigned to current user via exp.pending_for_me #}
        {% if exp.can_approve or exp.pending_for_me %}

          {# Accountant role branch #}
          {% if slug_role == "accountant" %}
            {% if exp.current_stage == "ACCOUNTANT" or exp.pending_for_me %}
              <form method="post" action="{% url 'expenses:unified-action' 'expense' exp.id 'approve' %}" class="d-inline">
                {% csrf_token %}
                <input type="text" name="remark" class="form-control form-control-sm mb-1" placeholder="Remark (optional)">
                <button type="submit" class="btn btn-success btn-sm">Approve</button>
              </form>
              <form method="post" action="{% url 'expenses:unified-action' 'expense' exp.id 'reject' %}" class="d-inline">
                {% csrf_token %}
                <input type="text" name="remark" class="form-control form-control-sm mb-1" placeholder="Remark (optional)">
                <button type="submit" class="btn btn-danger btn-sm">Reject</button>
              </form>
            {% else %}
              <span class="badge bg-info">Observer</span>
            {% endif %}

          {# Manager role branch #}
          {% elif slug_role == "manager" %}
            {% if exp.current_stage == "MANAGER" or exp.pending_for_me %}
              <form method="post" action="{% url 'expenses:unified-action' 'expense' exp.id 'approve' %}" class="d-inline">
                {% csrf_token %}
                <input type="text" name="remark" class="form-control form-control-sm mb-1" placeholder="Remark (optional)">
                <button type="submit" class="btn btn-success btn-sm">Approve</button>
              </form>
              <form method="post" action="{% url 'expenses:unified-action' 'expense' exp.id 'reject' %}" class="d-inline">
                {% csrf_token %}
                <input type="text" name="remark" class="form-control form-control-sm mb-1" placeholder="Remark (optional)">
                <button type="submit" class="btn btn-danger btn-sm">Reject</button>
              </form>
            {% else %}
              <span class="badge bg-info">Observer</span>
            {% endif %}

          {# Account Manager role branch #}
          {% elif slug_role == "account-manager" %}
            {% if exp.current_stage == "ACCOUNT_MANAGER" or exp.current_stage == "APPROVED" or exp.pending_for_me %}
              <form method="post" action="{% url 'expenses:unified-action' 'expense' exp.id 'approve' %}" class="d-inline">
                {% csrf_token %}
                <input type="text" name="remark" class="form-control form-control-sm mb-1" placeholder="Remark (optional)">
                <button type="submit" class="btn btn-success btn-sm">Approve</button>
              </form>
              <form method="post" action="{% url 'expenses:unified-action' 'expense' exp.id 'reject' %}" class="d-inline">
                {% csrf_token %}
                <input type="text" name="remark" class="form-control form-control-sm mb-1" placeholder="Remark (optional)">
                <button type="submit" class="btn btn-danger btn-sm">Reject</button>
              </form>

              {% if exp.status == "Approved" and not exp.reimbursed %}
                <form method="post" action="{% url 'expenses:unified-action' 'expense' exp.id 'settle' %}" class="d-inline mt-1 d-flex gap-2 align-items-center flex-wrap">
                  {% csrf_token %}
                  <input type="date" name="settlement_date" class="form-control form-control-sm" required>
                  <input type="text" name="remark" class="form-control form-control-sm" placeholder="Cash settlement remark (optional)">
                  <button type="submit" class="btn btn-outline-primary btn-sm">Settle by Cash</button>
                </form>
              {% endif %}
            {% else %}
              <span class="badge bg-info">Observer</span>
            {% endif %}

          {# Employee edit if allowed #}
          {% else %}
            {% if exp.employee.user == request.user and exp.current_stage == "ACCOUNTANT" and exp.status == "Submitted" %}
              <button class="btn btn-warning btn-sm edit-expense-btn" data-expense-id="{{ exp.id }}" data-bs-toggle="modal" data-bs-target="#expenseModal">Edit</button>
              <a href="{% url 'expenses:delete-expense' exp.id %}" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure you want to delete this expense?');">Delete</a>
            {% else %}
              <span class="badge bg-info">Observer</span>
            {% endif %}
          {% endif %}

        {% else %}
          <span class="badge bg-info">Observer</span>
        {% endif %}
      </td>
      {% endif %}
    </tr>
    {% empty %}
    <tr>
      <td colspan="12" class="text-center text-muted">No expenses found.</td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<table class="table table-bordered table-sm mt-2">
  <thead class="table-light">
    <tr>
      <th>Date Requested</th>
      <th>Employee</th>
      <th>Project</th>
      <th>Purpose</th>
      <th>Amount</th>
	  <th>Used</th>
	  <th>Balance</th>
      <th>Status</th>
      <th>Remark</th>
      {% if action != "none" %}
      <th>Actions</th>
      {% endif %}
    </tr>
  </thead>
  <tbody>
    {% for adv in items %}
    <tr>
      <td>{{ adv.date_requested }}</td>
      <td>{{ adv.employee.user.get_full_name }}</td>
      <td>{{ adv.project.name }}</td>
      <td>{{ adv.purpose }}</td>
      <td>â‚¹{{ adv.amount }}</td>
	  <td>â‚¹{{ adv.total_used|floatformat:2 }}</td>
	  <td>
		  {% if adv.balance >= 0 %}
			â‚¹{{ adv.balance|floatformat:2 }}
		  {% else %}
			<span class="text-danger">â‚¹{{ adv.balance|floatformat:2 }}</span>
		  {% endif %}
	  </td>


      <td>
        {% if adv.status == "Submitted" %}
          <span class="badge bg-secondary">Submitted</span>
        {% elif adv.status == "Forwarded to Accountant" %}
          <span class="badge bg-info text-dark">Forwarded to Accountant</span>
        {% elif adv.status == "Forwarded to Account Manager" %}
          <span class="badge bg-warning text-dark">Forwarded to Account Manager</span>
        {% elif adv.status == "Settled" %}
          <span class="badge bg-success">Settled</span>
        {% elif adv.status == "Rejected" %}
          <span class="badge bg-danger">Rejected</span>
        {% else %}
          <span class="badge bg-light text-dark">{{ adv.status }}</span>
        {% endif %}
      </td>

      <td>{{ adv.remarks|default:"â€“" }}</td>

      {% if action != "none" %}
		  {# expenses/unified/partials/table_advances.html #}
		  <td>
			{% with r=role|slugify %}
			  {# Manager stage #}
			  {% if r == "manager" and adv.current_stage == "MANAGER" %}
				<form method="post" action="{% url 'expenses:unified-action' 'advance' adv.id 'approve' %}" class="d-inline">
				  {% csrf_token %}
				  <input type="text" name="remark" class="form-control form-control-sm mb-1" placeholder="Remark (optional)">
				  <button type="submit" class="btn btn-success btn-sm">Approve</button>
				</form>
				<form method="post" action="{% url 'expenses:unified-action' 'advance' adv.id 'reject' %}" class="d-inline">
				  {% csrf_token %}
				  <input type="text" name="remark" class="form-control form-control-sm mb-1" placeholder="Remark (optional)">
				  <button type="submit" class="btn btn-danger btn-sm">Reject</button>
				</form>

			  {# Accountant stage #}
			  {% elif r == "accountant" and adv.current_stage == "ACCOUNTANT" %}
				<form method="post" action="{% url 'expenses:unified-action' 'advance' adv.id 'approve' %}" class="d-inline">
				  {% csrf_token %}
				  <input type="text" name="remark" class="form-control form-control-sm mb-1" placeholder="Remark (optional)">
				  <button type="submit" class="btn btn-success btn-sm">Approve</button>
				</form>
				<form method="post" action="{% url 'expenses:unified-action' 'advance' adv.id 'reject' %}" class="d-inline">
				  {% csrf_token %}
				  <input type="text" name="remark" class="form-control form-control-sm mb-1" placeholder="Remark (optional)">
				  <button type="submit" class="btn btn-danger btn-sm">Reject</button>
				</form>

			  {# Account Manager settlement stage #}
			  {% elif r == "account-manager" and adv.current_stage == "ACCOUNT_MANAGER" %}
				<form method="post" action="{% url 'expenses:unified-action' 'advance' adv.id 'settle' %}" class="d-flex gap-2 align-items-center">
				  {% csrf_token %}
				  <input type="date" name="settlement_date" class="form-control form-control-sm" required>
				  <input type="text" name="remark" class="form-control form-control-sm" placeholder="Remark (optional)">
				  <button type="submit" class="btn btn-success btn-sm">Settle</button>
				</form>
				{% if adv.status == "Settled" and adv.settlement_date %}
				  <small class="text-muted d-block mt-1">Settled on: {{ adv.settlement_date }}</small>
				{% endif %}

			  {# Employee can edit/delete while Submitted@MANAGER #}
			  {% elif adv.employee.user == request.user and adv.current_stage == "MANAGER" and adv.status == "Submitted" %}
				<button class="btn btn-warning btn-sm edit-advance-btn" data-advance-id="{{ adv.id }}">Edit</button>
				<a href="{% url 'expenses:delete-advance' adv.id %}" class="btn btn-danger btn-sm"
				   onclick="return confirm('Are you sure you want to delete this advance request?');">
				  Delete
				</a>

			  {# Everyone else #}
			  {% else %}
				<span class="badge bg-info">Observer</span>
			  {% endif %}

			  {# ðŸ”Ž Tiny toggle to show per-advance deductions (works for everyone) #}
				<button class="btn btn-outline-secondary btn-sm mt-2" type="button"
						data-bs-toggle="collapse" data-bs-target="#adj-{{ adv.id }}">
				  View Adjustments
				</button>
				<div class="collapse mt-2" id="adj-{{ adv.id }}">
				  <div class="card card-body p-2">
					{% with adj_list=adv.adjustments.all %}
					  {% if adj_list %}
						<table class="table table-sm mb-0">
						  <thead>
							<tr><th>Date</th><th>Expense</th><th>Amount Deducted</th></tr>
						  </thead>
						  <tbody>
							{% for log in adj_list %}
							  <tr>
								<td>{{ log.created_at|date:"Y-m-d H:i" }}</td>
								<td>
								  #{{ log.expense.id }}
								  â€” {{ log.expense.new_expense_type.name }}
								  (â‚¹{{ log.expense.amount }})
								</td>
								<td>â‚¹{{ log.amount_deducted|floatformat:2 }}</td>
							  </tr>
							{% endfor %}
						  </tbody>
						</table>
					  {% else %}
						<small class="text-muted">No deductions yet.</small>
					  {% endif %}
					{% endwith %}
				  </div>
				</div>

			{% endwith %}
		  </td>
	  {% endif %}
									
    </tr>
    {% empty %}
    <tr>
      <td colspan="9" class="text-center text-muted">No advances found.</td>
    </tr>
    {% endfor %}
  </tbody>
</table>

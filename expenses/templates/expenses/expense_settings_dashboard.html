{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="container">
    <h2 class="mb-4">Expense Settings</h2>

    <!-- Back to Dashboard -->
    <form method="post" action="{% url 'accounts:profile' %}">
        {% csrf_token %}
       <!-- <button type="submit" class="btn btn-secondary mb-4 shadow-sm">
            <i class="bi bi-house me-2"></i>Dashboard
        </button>-->
    </form>

    <!-- SECTION 1: Manage Expense Types -->
    <div class="card mb-5 shadow-sm">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Manage Expense Types</h5>
        </div>
        <div class="card-body">
            <form method="post" action="{% url 'expenses:expense-settings' %}">
                {% csrf_token %}
                <div class="row g-3 align-items-end">
                    <div class="col-md-4">
                        <label class="form-label">Type Name</label>
                        <input type="text" name="name" class="form-control" required>
                    </div>
                    <div class="col-md-2">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="requires_kilometers">
                            <label class="form-check-label">Requires KM</label>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="requires_receipt">
                            <label class="form-check-label">Requires Receipt</label>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Rate/km</label>
                        <input type="number" step="0.01" name="rate" class="form-control">
                    </div>
                    <div class="col-md-2 text-end">
                        <button type="submit" name="add_type" class="btn btn-primary">Add Type</button>
                    </div>
                </div>
            </form>

            <table class="table table-bordered mt-4">
                <thead class="table-light">
                    <tr>
                        <th>Name</th>
                        <th>Requires KM</th>
                        <th>Requires Receipt</th>
                        <th>Rate/km</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for type in types %}
                        <tr>
                            <td>{{ type.name }}</td>
                            <td>{{ type.requires_kilometers|yesno:"Yes,No" }}</td>
                            <td>{{ type.requires_receipt|yesno:"Yes,No" }}</td>
                            <td>{{ type.rate_per_km|default:"-" }}</td>
                            <td>
                                <form method="post" action="{% url 'expenses:delete-expense-type' type.id %}" style="display:inline;">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure?')">Delete</button>
                                </form>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- SECTION 2: Global Grace Period -->
    <div class="card shadow-sm mb-5">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0">Global Expense Submission Settings (Grace Period)</h5>
        </div>
        <div class="card-body">
            <form method="post" action="{% url 'expenses:expense-settings' %}">
                {% csrf_token %}
                <input type="hidden" name="update_grace" value="1">
                <div class="row g-3 align-items-center">
                    <div class="col-md-6">
                        <label for="grace_days" class="form-label">Grace Period (in days)</label>
                        <input type="number" id="grace_days" name="expense_grace_days"
                               class="form-control" value="{{ grace_period }}" min="1" required>
                    </div>
                    <div class="col-md-4 text-end">
                        <button type="submit" class="btn btn-success">Update Global Grace Period</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- SECTION 3: Per-Employee Grace Period -->
    <div class="card shadow-sm">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0">Employee-Specific Grace Period</h5>
        </div>
        <div class="card-body">
            <form method="post" action="{% url 'expenses:expense-settings' %}">
                {% csrf_token %}
                <input type="hidden" name="update_employee_grace" value="1">
                <div class="row g-3 align-items-center">
                    <div class="col-md-4">
                        <label class="form-label">Select Employee</label>
                        <select name="employee_id" class="form-select" required>
                            <option value="">-- Select Employee --</option>
                            {% for emp in employees %}
                                <option value="{{ emp.id }}" {% if selected_employee and emp.id == selected_employee.id %}selected{% endif %}>
                                    {{ emp.user.get_full_name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Grace Period (in days)</label>
                        <input type="number" name="employee_grace_days" class="form-control"
                               value="{{ employee_grace_period|default:'' }}" min="0" required>
                    </div>
                    <div class="col-md-4 text-end">
                        <button type="submit" class="btn btn-info text-white">Update Employee Grace</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
	
	 <!-- SECTION 3: Employee list of changed Grace Period -->
	{% if custom_grace_employees %}
    <div class="card shadow-sm mt-5">
        <div class="card-header bg-warning">
            <h5 class="mb-0 text-white">Employees with Custom Grace Periods</h5>
        </div>
        <div class="card-body">
            <table class="table table-bordered table-hover">
                <thead class="table-light">
                    <tr>
                        <th>Employee</th>
                        <th>Email</th>
                        <th>Custom Grace (days)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for entry in custom_grace_employees %}
                    <tr>
                        <td>{{ entry.employee.user.get_full_name }}</td>
                        <td>{{ entry.employee.user.email }}</td>
                        <td>{{ entry.days }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

	{% endif %}
	{% if request.user.is_superuser %}
	<!-- SECTION 4: Delete Timesheet, DA, C-Off Data -->
	<!-- SECTION: Delete Timesheet, DA, C-Off Data -->
	<div class="card shadow-sm mt-5">
		<div class="card-header bg-danger text-white">
			<h5 class="mb-0">Delete Timesheet, DA, C-Off Records</h5>
		</div>
		<div class="card-body">
			<form method="get" action="{% url 'timesheet:delete-employee-data' 0 %}" onsubmit="event.preventDefault(); redirectToDeletion();">
				<div class="row g-3 align-items-center">
					<div class="col-md-8">
						<label class="form-label">Select Employee</label>
						<select id="employeeDeleteSelect" class="form-select" required>
							<option value="">-- Select Employee --</option>
							{% for emp in employees %}
								<option value="{{ emp.id }}">{{ emp.user.get_full_name }}</option>
							{% endfor %}
						</select>
					</div>
					<div class="col-md-4 text-end">
						<button type="submit" class="btn btn-danger mt-2">
							Delete Data
						</button>
					</div>
				</div>
			</form>
		</div>
	</div>

	<!-- Script: Redirect to Delete View -->
	<script>
	function redirectToDeletion() {
		const empId = document.getElementById('employeeDeleteSelect').value;
		if (!empId) {
			alert("Please select an employee.");
			return;
		}

		const urlTemplate = "{% url 'timesheet:delete-employee-data' 0 %}";
		const targetUrl = urlTemplate.replace("0", empId);
		window.location.href = targetUrl;
	}
	</script>
	{% endif %}




</div>
{% endblock %}

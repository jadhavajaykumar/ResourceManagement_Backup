{% extends 'base.html' %}
{% load dict_extras_acc %}

{% block content %}
<div class="container mt-4">
  <h3 class="mb-4 text-primary">Expense & DA Approval Dashboard</h3>

  <!-- Filter Section -->
  <form method="get" class="row g-3 mb-4">
    <div class="col-md-3">
      <label for="project">Project</label>
      <select name="project" id="project" class="form-select">
        <option value="">All</option>
        {% for proj in projects %}
          <option value="{{ proj.project__id }}" {% if request.GET.project == proj.project__id|stringformat:"s" %}selected{% endif %}>
            {{ proj.project__name }}
          </option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3">
      <label for="start_date">From Date</label>
      <input type="date" name="start_date" class="form-control" value="{{ request.GET.start_date }}">
    </div>
    <div class="col-md-3">
      <label for="end_date">To Date</label>
      <input type="date" name="end_date" class="form-control" value="{{ request.GET.end_date }}">
    </div>
    <div class="col-md-3 d-flex align-items-end">
      <button class="btn btn-primary">Apply Filters</button>
    </div>
  </form>

  <!-- Export -->
  <div class="mb-3 text-end">
    <form method="get" id="exportForm" action="">
      <input type="hidden" name="project" value="{{ request.GET.project }}">
      <input type="hidden" name="from_date" value="{{ request.GET.from_date }}">
      <input type="hidden" name="to_date" value="{{ request.GET.to_date }}">
      <button type="submit" class="btn btn-outline-success">Export Excel</button>
	  <a href="{% url 'accountant:export-advance-summary' %}" class="btn btn-outline-info ms-2">Export Advance Summary</a>
    </form>
  </div>

  <!-- Tabs -->
  <ul class="nav nav-tabs mb-3" id="approvalTabs" role="tablist">
    {% for tab in tab_names %}
      <li class="nav-item" role="presentation">
        <button class="nav-link {% if forloop.first %}active{% endif %}" id="{{ tab }}-tab" data-bs-toggle="tab" data-bs-target="#{{ tab }}-tab-pane" type="button" role="tab">
          {{ tab|capfirst }}
        </button>
      </li>
    {% endfor %}
  </ul>

  <!-- Tab Content -->
  <div class="tab-content" id="approvalTabContent">
    {% for tab in tab_names %}
      <div class="tab-pane fade {% if forloop.first %}show active{% endif %}" id="{{ tab }}-tab-pane" role="tabpanel">
        <table class="table table-striped table-hover align-middle">
          <thead class="table-light sticky-top">
            <tr>
              <th>Employee</th>
              <th>Project</th>
              <th>Amount (₹)</th>
              <th>Type</th>
              <th>Date</th>
              <th>Status</th>
              <th>Reimbursement</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% with data=tabbed_expenses|get_item:tab %}
              {% if data %}
                {% for row in data %}
                  {% if row.type == "Expense" %}
                    <tr>
                      <td>{{ row.employee.user.get_full_name }}</td>
                      <td>{{ row.project.name }}</td>
                      <td>{{ row.amount }}</td>
                      <td>{{ row.new_expense_type.name }}</td>
                      <td>{{ row.date }}</td>
                      <td>{{ row.status }}</td>
                      <td>{{ row.reimbursed|yesno:"Yes,No" }}</td>
                      <td>
                        {% if row.status == 'Pending' %}
                          <button class="btn btn-sm btn-success" onclick="openRemarkModal('{{ row.id }}', 'approve')">✓</button>
                          <button class="btn btn-sm btn-danger" onclick="openRemarkModal('{{ row.id }}', 'reject')">✗</button>
                        {% else %}
                          <div class="small text-muted">
                            {% if row.advance_used %}
                              <span class="badge bg-info text-dark">Adv #{{ row.advance_used }}</span>
                            {% else %}
                              <span class="badge bg-secondary">No Advance</span>
                            {% endif %}
                          </div>
                        {% endif %}
                      </td>
                    </tr>
                  {% elif row.type == "DA" %}
                    <tr class="table-warning text-dark">
                      <td>{{ row.employee.user.get_full_name }}</td>
                      <td>{{ row.project.name }}</td>
                      <td>{{ row.amount }}</td>
                      <td>Daily Allowance</td>
                      <td>{{ row.date }}</td>
                      <td>{{ row.status }}</td>
                      <td>{{ row.reimbursed|yesno:"Yes,No" }}</td>
                      <td>
                        {% if not row.approved %}
                          <form method="post" action="{% url 'accountant:approve-da' row.id %}">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm btn-outline-success">✓</button>
                          </form>
                        {% else %}
                          <span class="text-muted">✓</span>
                        {% endif %}
                      </td>
                    </tr>
                  {% elif row.type == "Advance" %}
                    <tr class="table-info text-dark">
                      <td>{{ row.employee.user.get_full_name }}</td>
                      <td>{{ row.project.name }}</td>
                      <td>{{ row.amount }}</td>
                      <td><strong>Advance Request</strong></td>
                      <td>{{ row.date }}</td>
                      <td>
                        Manager: {% if row.approved_by_manager %}✓{% else %}✗{% endif %}<br>
                        Accountant: {% if row.approved_by_accountant %}✓{% else %}✗{% endif %}
                      </td>
                      <td>-</td>
                      <td>
                        {% if row.approved_by_manager and not row.approved_by_accountant %}
                          <a href="{% url 'accountant:accountant_approve_advance' row.id %}" class="btn btn-sm btn-success">Approve</a>
                        {% elif row.approved_by_accountant %}
                          <span class="text-muted">Approved</span>
                        {% else %}
                          <span class="text-muted">Pending Manager</span>
                        {% endif %}
                      </td>
                    </tr>
                  {% endif %}
                {% endfor %}
              {% else %}
                <tr><td colspan="8" class="text-center text-muted">No entries found.</td></tr>
              {% endif %}
            {% endwith %}
          </tbody>
        </table>
      </div>
    {% endfor %}
  </div>

  <!-- Approval Modal -->
  <div class="modal fade" id="remarkModal" tabindex="-1">
    <div class="modal-dialog">
      <form method="post" id="remarkForm">
        {% csrf_token %}
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Add Remark</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <textarea name="remark" class="form-control" required></textarea>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">Submit</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  function updateExportLink() {
    const activeTab = document.querySelector('.nav-link.active').id.replace('-tab', '');
    const exportForm = document.getElementById('exportForm');
    exportForm.action = `/accountant/export/${activeTab}/`;
  }

  updateExportLink();
  document.querySelectorAll('.nav-link').forEach(btn => {
    btn.addEventListener('click', () => setTimeout(updateExportLink, 200));
  });

  function openRemarkModal(expenseId, action) {
    const form = document.getElementById('remarkForm');
    form.action = `/accountant/expenses/${expenseId}/${action}/`;
    document.querySelector('#remarkForm textarea').value = "";
    new bootstrap.Modal(document.getElementById('remarkModal')).show();
  }
</script>
{% endblock %}
